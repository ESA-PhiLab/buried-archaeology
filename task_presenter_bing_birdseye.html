<style>
.imagery {
    transition: transform .2s; /* Animation */
    height: 150px;
    border-width: 1px;
    border-style: solid;
    border-color: white;
    border-radius: 0px;
    padding: 0px;
}

.imagery:hover {
    transform: scale(2.5); /* (250% zoom) */
}
</style>

<div style="text-align: center; padding-bottom:50px;">
  <div class="row row-task-id">
    <div class="col-md-12" style="text-align: right;">
      <p>
        <span>You are now working on task:</span> <span id="task-id" class="label label-warning">#</span>
      </p>
    </div>
  </div>

  <div class="row">
    <!-- Success and Error Messages for the user. --> 
    <div class="col-md-12" style="height:30px">
      <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            <span>Loading next task...</span>
        </div>
      <div id="finish" class="alert alert-success" style="display:none;">
        <strong>Congratulations!</strong> <span>You have contributed to all available tasks!</span>
        <br/>
      </div>
      <div id="error" class="alert alert-danger" style="display:none;">
          <a class="close">×</a>
          <strong>Error!</strong> Something went wrong, please contact the project administrator.
      </div>
    </div> <!-- End Success and Error Messages for the user. -->
  </div>

  <div class="row row-skeleton"> <!-- Start Task Row-->
    <div class="row">
        <div class="col-md-12">
            <h1>Can you see crop marks?</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <p>
              <span>You can hover on a tile to increase its size.</span>
            </p>
          <div id="imagery-container">
              <img id="imagery" style="display: block; margin: 0 auto;" src="https://i.imgur.com/GeHxzb7.png" style="height:400px;">
            </div>
            <p>
              <span id="imagery-timestamp"></span>
            </p>
        </div>
    </div>
    <div class="row" style="padding-top:15px;">
      <div class="answer-btns-container col-md-12" align="center">
        <button type="button" class="btn btn-primary btn-lg btn-user-answer" value="Yes">Yes</button>
        <button type="button" class="btn btn-secondary btn-lg btn-user-answer" value="No">No</button>
        <button type="button" class="btn btn-warning btn-lg btn-user-answer" value="Bad Image">Bad Image</button>
      </div>
    </div>
  </div> <!-- End Task Row -->
</div>


<script type="text/javascript">
(function() {
  
    // Making sure that the buttons are under the zoomed in tiles. 
    $("#imagery-container").mouseover(function() {
      $( ".answer-btns-container").css('z-index', -1);
    });
  
    // Making sure that the buttons remain clickable.
    $( "#imagery-container" ).mouseleave(function() {
      $(".answer-btns-container").css('z-index', 1);
    });
      
    pybossa.taskLoaded(function(task, deferred) {
        if(!$.isEmptyObject(task)) {

            var BING_API_KEY = 'XXXX';
            
            // Get img url subdomain
            var imgUrlSubdomain = task.info['img_url_subdomain'];
            
            // Each task is a 2D grid.
            // Get the size of that grid in order to iterator over it. 
            tilesX = task.info['tiles_x'];
            tilesY = task.info['tiles_y'];

            // Build an image HTML element for each tile in the grid.
            for(var tileId=0; tileId < (tilesY * tilesX); tileId++){

              var img = $('<img class="imagery" id="imagery' + tileId + '" data-index="' + tileId + '" />');
              img.load(function() {
             
                  // Continue as soon as the image is loaded.
                  deferred.resolve(task);
              });
            
              // Build image URL.
              var imgUrl = task.info.img_url.replace('{subdomain}', imgUrlSubdomain).replace('{tileId}', tileId).replace('BING_API_KEY', BING_API_KEY);
            
              // Set HTML properties.
              img.attr('src', imgUrl);
              img.addClass('img-thumbnail img-responsive');
              
              task.info['image' + tileId] = img;
            }
        }
        else {
            deferred.resolve(task);
        }
    });

    pybossa.presentTask(function(task, deferred){
      
      if (!$.isEmptyObject(task)) {
        // Clear HTML content of container (to remove default loading image).
        $('#imagery-container').html('');

        // Display task ID.
        $('#task-id').html(task.id);

        // Each task is a 2D grid.
        // Get the size of that grid in order to iterator over it.
        tilesX = task.info['tiles_x'];
        tilesY = task.info['tiles_y'];

        // Track tileId.
        var tileId = 0;

        for(var y=0; y <tilesY; y++){
          for(var x=0; x<tilesX; x++){
            $('#imagery-container').append(task.info['image' + tileId]);

            // Increment tile Id prioe to next iteration so that next image is fetched.
            tileId++;
          }
          
          // Next loop is the begining of a new row of tiles.
          // Skip line to start a new row.
          $('#imagery-container').append('<br>')
        }
      
        
        // Display first image timestamp.
        $('#imagery-timestamp').html(task.info['start_date']);
      
        $('.btn-user-answer').off('click').on('click', function(evt) {

            var answer = $(this).attr("value");
          
            if (typeof answer != 'undefined') {
                pybossa.saveTask(task.id, answer).done(function(){
                deferred.resolve();
              });
              $("#loading").fadeIn(500);
            }else {
              $("#error").show();
            }
        });
        $("#loading").hide();

      }else{
        $(".row-task-id").hide();
        $(".row-skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
      }
  });

    pybossa.run('XXXX');
})();
</script>